## СУБД - Домашнее задание 3

### При проведении нагрузочного тестирования в качестве основной сущности, которая представляет максимальную бизнес ценность для нашего приложения, была выбрана сущность "Заказ". Инструмент для нагрузочного тестирования - утилита wrk (https://github.com/wg/wrk).
Для выполнения скриптов нужно указать session_id в заголовках запроса + менять числовые параметры при получениии заказов, чтобы получать валидные ответы от сервера.

1. Запуск нагрузочного тестирования на создание заказов: /api/v1/order/create
```$ wrk -t4 -c100 -d30s --latency -s db/perf_test/order_create.lua https://bizonshop.site```
```
Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency   164.66ms  131.27ms   1.30s    85.37%
    Req/Sec   169.48     40.37   290.00     69.73%
Latency Distribution
     50%  121.21ms
     75%  206.59ms
     90%  337.54ms
     99%  650.84ms
20213 requests in 30.03s, 8.25MB read
Requests/sec:    673.14
Transfer/sec:    281.35KB
```

При нескольких повторных запусках можно добиться создания 100000 записей и с каждым разом среднее время выполенения запроса растет.
Это может быть связано со следущими факторами:
- В таблице есть индексы на id заказа, => при добавлении каждой новой записи база данных должна обновить этото индекс, а чем больше записей, тем дольше выполняется эта операция
- В таблице есть поля с автоинкрементом, поскольку СУБД должна гарантировать уникальность этих значений, это может замедлять процесс добавления записей
- По мере заполнения данными, СУБД сложнее искать место на диске для новой записи

2. Запуск нагрузочного тестирования на получение заказов: /api/v1/order/{:id}
```$ wrk -t4 -c100 -d30s --latency -s db/perf_test/order_get.lua https://bizonshop.site```
```
Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency    43.39ms   21.58ms   1.10s    98.39%
    Req/Sec   560.36     61.70   710.00     78.17%
Latency Distribution
     50%   41.88ms
     75%   45.44ms
     90%   49.60ms
     99%   72.97ms
66987 requests in 30.03s, 29.32MB read
Requests/sec:   2230.71
Transfer/sec:      0.98MB
```

Время выполнения запроса приемлемое. Объем трафика можно увеличить, добавив сжатие данных в конфигурации nginx.

Также при тестировании дополнительного эндпоинта, который возвращает все заказы определенного пользователя, была ваявлена критическая проблема: при большом количстве заказов у одного пользователя (~ > 10000) запросы перестают приходить, т.к. не помещабтся в отведенный таймаут. Это серьезная ошибка, связанная с большим количесвтом операций объединения таблиц и поиска по соответивию ключей. Как вариант решения, можно следить за количеством заказов пользователя, удаляя (либо архивируя в отдельной таблице) слишком старые заказы.